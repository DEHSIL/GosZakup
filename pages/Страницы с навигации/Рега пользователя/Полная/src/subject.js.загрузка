/**
 * Created by sapa on 11.06.2014.
 */
var inis_clock = 0;

function get_url() {
    var lang = 'ru';
    var url = window.location.href.split('/');
    var http = location.protocol;
    var hostname = window.location.hostname;

    switch (url[3]) {
        case 'kz':
        case 'en':
            lang = url[3];
            break
        default:
            lang = 'ru';
            break;
    }

    return http + '//' + hostname + '/' + lang + '/subject/';
}

function site_url() {
    var lang = 'ru';
    var url = window.location.href.split('/');
    var http = location.protocol;
    var hostname = window.location.hostname;

    switch (url[3]) {
        case 'kz':
        case 'en':
            lang = url[3];
            break
        default:
            lang = 'ru';
            break;
    }

    return http + '//' + hostname + '/' + lang + '/subject/';
}

function send_inis_request() {
    $('#requestResult').html('<div class="alert alert-info">Выполняется запрос <span id="clock" class="label label-info"></span></div>');
    $('#sendRequest').attr('disabled', true);
    inis_clock = 0;
    jsClock();
    $.ajax({
        type: "GET",
        url: get_url() + 'ajax_inis_request',
        data: {tax_payer_type: $('#tax_payer_type').val()},
        success: function (data, status) {
            inis_clock = -1;
            $('#requestResult').html(data);
            // $('#user_progressbar').css('width', '66%');
            // $('#user_progressbar span').html('66%');
            // $('#user_progressbar').attr('aria-valuenow', '66');
            $('#sendRequest').attr('disabled', false);
            return;
        },
        error: function (jqXHR, textStatus, errorThrown) {
            // $('#user_progressbar').css('width', '33%');
            // $('#user_progressbar span').html('33%');
            // $('#user_progressbar').attr('aria-valuenow', '33')
            $('#sendRequest').attr('disabled', false);
            inis_clock = 301;
            $('#form_ajax_alert').html('<div class="alert alert-danger">Ошибка сервера [' + errorThrown + ']</div>');
            return;
        }
    });
}

function update_subject_frominis() {
    $('#loading').show();
    $('#ajax_result').html('<div class="alert alert-info">Выполняется запрос <span id="clock" class="label label-info"></span></div>');
    $('#sendRequest').attr('disabled', true);
    inis_clock = 0;
    jsClock();
    $.ajax({
        type: "GET",
        url: site_url() + 'ajax_subject_inis_update',
        success: function (data, status) {
            inis_clock = -1;
            $('#loading').hide();
            $('#ajax_result').html(data);
            $('#sendRequest').attr('disabled', false);
            return;
        },
        error: function (jqXHR, textStatus, errorThrown) {
            $('#loading').hide();
            $('#ajax_result').html('<div class="alert alert-danger">Ошибка выполнения запроса, ' + errorThrown + '</div>');
            $('#sendRequest').attr('disabled', false);
            inis_clock = 301;
            return;
        }
    });
}



function jsClock() {
    if (inis_clock > 300) {
        $('#requestResult').html('<div class="alert alert-danger">Ошибка выполнения запроса, попробуйте еще раз</div>');
        return;
    }
    if (inis_clock < 0) return;
    inis_clock += 1;
    $('#clock').html(inis_clock + ' сек.');
    setTimeout("jsClock()", 1000);
}

function subject_button_no(message) {
    $('#form_ajax_alert').html('<div class="alert alert-warning">' + message + '</div>')
}

function subject_button_ok() {
    $('#form_ajax_alert').html('');
    var frmdata = $('#frm_agr_sign').serialize();

    $('#btn_subject_button_ok').prop("disabled", true);
    $("#btn_loading").addClass('glyphicon-refresh-animate');

    $.ajax({
        type: "POST", dataType: "json",
        url: get_url() + 'ajax_subject_reg_confirm',
        data: frmdata,
        success: function (js, status) {
            $("#btn_loading").removeClass('glyphicon-refresh-animate');
            if (js.st == 'ok') {
                $('#btn_user_button_ok').hide();
                document.location.href = js.url;
            } else {
                $('#btn_subject_button_ok').prop("disabled", false);
                $("button.btn-add-signature[data-file-identifier='sign']").show();
                $('#frm_agr_sign > input[name="signature\[sign\]"]').val("");
                $('#frm_agr_res').hide();
            }
            $('#form_ajax_alert').html(js.msg);
        },
        error: function (jqXHR, textStatus, errorThrown) {
            $("#btn_loading").removeClass('glyphicon-refresh-animate');
            $('#btn_subject_button_ok').prop("disabled", false);
            $("button.btn-add-signature[data-file-identifier='sign']").show();
            $('#frm_agr_sign > input[name="signature\[sign\]"]').val("");
            $('#frm_agr_res').hide();
            $('#form_ajax_alert').html('<div class="alert alert-danger">Ошибка сервера [' + errorThrown + ']</div>');

        }
    });
}